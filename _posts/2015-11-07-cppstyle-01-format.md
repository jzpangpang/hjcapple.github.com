---
title: C++ 编程规范（1）-- 格式
layout: post
published: true
---

这个规范是我在以前的公司制定的，我自己一直按照这个规范来写代码，现在重新整理出来。每个人都有自己的习惯，让别人都遵从某件事是很难的。现在我都不奢望可以改变其他人了，但还可以让自己做好一点点。

## 综述

C++ 是一门十分复杂并且威力强大的语言，使用这门语言的时候我们应该有所节制，绝对的自由意味着混乱。

我十分清楚每个人对怎么编写代码都有自己的偏好。这里定下的规范，某些地方可能会跟个人原来熟悉的习惯相违背，并引起不满。但多人协作的时候，需要有一定规范。定下一些规范，当大家面对某些情况，有所分歧的时候，容易达成共识。另外通过一定规范，加强代码的一致性，从团队中某人的代码切换到另一个人的代码，会更为自然，让别人可以读懂你的代码是很重要的。

通常面对某种情况，会有两种或更多种做法，我们就挑选其中一种，共同遵守。这并不表示另一种做法就是错的，只是仅仅不同。

这里规范是死的，现实是多变的，当你觉得某些规范，对你需要解决问题反而有很大限制，可以违反，但要有理由，而不仅仅是借口。那到底是否在寻找借口，并没有很明确的判断标准。这就如同不能规定少于多少根头发为秃头，但当我们看到某个人的时候，自然能够判断他是否是秃头。同样，当我们碰到具体情况的时候，自然能够判断是否在寻找借口。

本规范编写过程中，大量参考了[《Google C++ 编程规范》](http://blog.jobbole.com/64098/)，Google那份规范十分好，建议大家对比着看。

## 1 格式
### 1.1 每行代码不多于80个字符
从前的电脑终端，每行只可以显示80个字符。现在有更大更宽的显示屏，很多人会认为这条规则已经没有必要。但我们有充分的理由：

* 版本控制软件，或者编码过程中，经常需要在同一显示屏幕上，左右并排对比新旧两个文件。80个字符的限制，使得两个文件都不会折行，对比起来更清晰。
* 当代码超过 3 层嵌套，代码行就很容易超过80个字符。这条规则防止我们嵌套太多层级，层级嵌套太深会使得代码难以读懂。

规则总会有例外。比如当你有些代码行，是82个字符，假如我们强制规定少于80字符，人为将一行容易读的代码拆分成两行代码，就太不人性化了。我们可以适当超过这个限制。

### 1.2 使用空格(Space)，而不是制表符(Tab)来缩进，每次缩进4个字符
代码编辑器，基本都可以设置将Tab转为空格，请打开这个设置。

制表符在每个软件中的显示，都会有所不同。有些软件中每个Tab缩进8个字符，有些软件每个Tab缩进4个字符，随着个人的设置不同而不同。只使用空格来缩进，保证团队中每个人，看同一份代码，格式不会乱掉。

### 1.3 指针符号*，引用符号& 的位置，写在靠近类型的地方

	CCNode* p = CCNode::create(); // (1)
	CCNode *p = CCNode::create(); // (2)

也就说，上面两种写法。写成第(1)种。

我知道这个规定有很大的争议。指针符号到底靠近类型，还是靠近变量，这争论一直没有停过。其实两种写法都没有什么大问题，关键是统一。经考虑，感觉第1种写法更统一更合理。理由：

* 在类中连续写多个变量，通常会用Tab将变量对齐。(Tab会转化成空格)。比如

		CCNode*    _a;
		CCNode     _b;
		int        _c;
  当星号靠近类型而不是变量。\_a, \_b, \_c 等变量会很自然对齐。

  而当星号靠近变量，如果不手动多按空格微调，会写成。

 		CCNode      *_a;
 		CCNode      _b;
 		int         _c;

* 指针符号靠近类型，语法上更加统一。比如

		const char* getTableName();
		static_cast<CCLayer*>(node);			    

反对第一种写法的理由通常是：

* 假如某人连续定义多个变量，就会出错。

		int* a, b, c;
  上面写法本身就有问题。应该每行定义一个变量, 并初始化。

  		int* a = nullptr;
  		int* b = nullptr;
  		int* c = nullptr;

* Xcode中，默认的语法提示，指针符号靠近变量，我再修改成靠近类型，比较麻烦。

  这个有点道理。但我们也不能十分依赖工具。可以使用clang_format等美化工具去辅助调整代码。
  
### 1.4 花括号位置
采用Allman风格，if, for, while，namespace, 命名空间等等的花括号，另起一行。例子

	for (auto i = 0; i < 100; i++)
	{
		printf("%d\n", i);
	}

这条规定，很可能又引起争议。很多人采用 K&R 风格，将上面代码写成

	for (auto i = 0; i < 100; i++) {
		printf("%d\n", i);
	}

K&R风格在书籍印刷上会节省纸张。但在实际的代码中显得过于密集。Allman风格会更加清晰易读。当然，这理由带有很多主观因素。

### 1.5 if, for, while等语句就算只有一行，也强制使用花括号

永远不要省略花括号，不要写成：

	if ((err = SSLHashSHA1.update(&hashCtx, &signedParams)) != 0)
    	goto fail;

需要写成：

	if ((err = SSLHashSHA1.update(&hashCtx, &signedParams)) != 0)
	{
        goto fail;
    }

省略花括号，以后修改代码，或者代码合并的时候，容易直接多写一行。如

	if ((err = SSLHashSHA1.update(&hashCtx, &signedParams)) != 0)
    	goto fail;
    	goto fail;
    	
就会引起错误。

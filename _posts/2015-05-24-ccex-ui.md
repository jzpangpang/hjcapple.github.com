---
title: cocos2dx-lua，界面库的设计
layout: post
published: true

---

使用cocos2dx做游戏的过程中，没有一个界面编辑器，搭建界面是很麻烦的。官方有个CocosStudio, 但是用起来太复杂了。另外我们使用用Flash导出的矢量来动态生成图片，这样就需要界面编辑器，可以识别我们定义的矢量格式。CocosStudio是闭源的，修改不了它。

界面编辑器可以分两步来实现，

1. 先可以人手工编写配置文件。
2. 再使用工具来生成配置文件。

人手工编辑配置，再使用解析库根据配置来生成界面。这样问题就集中到，怎么去设计配置文件。

先选格式。可以自己设计一种外部DSL, 这样配置语法可以没有约束，可以定义得很简洁。但是这样的话，就需要编写一系列的解析工具，语法检查工具，比较麻烦。

也可以选择通用的文本格式，比如xml, json, lua。

xml 的问题是太啰嗦了，人手写xml简直是反人类。json好一点，但也是显得语法噪音过多。我们使用的是cocos2dx-lua, 最好的选择就是使用lua本身来定义配置文件，这样就可以利用lua自身来解析lua，一个require就可以了。

写一个库，最重要的是接口设计，可以先模拟它人是怎么使用的。

UI界面自然会有一种层级关系，先来看看怎么表示层级关系，类似这样

	Layer = {
		tag = 1,
		name = "layer1",
		position = { 10, 20 },
			
		Button = {
			tag = 1,
			name = "button1",
			position = { 10, 20 },
		},
		
		Button = {
			tag = 1,
			name = "button2",
			position = { 10, 20 },
		},
	}
	
这种设计表示Layer, 下面有两个Button, 写起来很自然，读起来也好读，但问题是这样不符合lua的语法。因为lua中字典的key不能是相同的，上面例子中Button作为key，名字重复了。相应地，我们将配置调整一下，使它符合lua语法，大致变成，

	{
		class = cc.Layer
		tag = 1,
		name = "layer1",
		position = { 10, 20 },
			
		{
			{
				class = cc.Button,
				tag = 1,
				name = "button1",
				position = { 10, 20 },
			},
			
			{
				class = cc.Button,
				tag = 1,
				name = "button2",
				position = { 10, 20 },
			},
		}
	}
	
这样配置就变成了一个lua表格，也容易解析，但是这样读起来不好读，写起来也麻烦。注意那两个Button, Layer的一系列children就变成了一个数组，多了很多个缩进。

那有没有更好的方法呢，上一版的写法，问题是字典的key不能重复，假如我们可以绕过这个就好了。

我们可以利用lua的一个语法特性，lua的函数调用，假如函数的参数是一个table, 两边的()可以省略。比如可以写成

	fun {
	}
	
跟着这个语法特点，我们将上面的配置写成
	
	Layer {
		tag = 1,
		name = "layer1",
		position = { 10, 20 },
			
		Button {
			tag = 1,
			name = "button1",
			position = { 10, 20 },
		},
		
		Button {
			tag = 1,
			name = "button2",
			position = { 10, 20 },
		},
	}
	
注意，这时候 Layer, 跟Button都是一个函数调用。之后的 Label, TableView 等等都变成函数调用。

这时候，再次出现一个问题，定义太多的函数，容易污染全局空间。我们只想 Button, Label等函数，只可以在一个范围中使用。这时，我们再用一些小手段。

 	ui.parse("Layer") {
 		tag = 1,
		name = "layer1",
		position = { 10, 20 },
			
		Button {
			tag = 1,
			name = "button1",
			position = { 10, 20 },
		},
		
		Button {
			tag = 1,
			name = "button2",
			position = { 10, 20 },
		},
 	}
 	
ui.parse 的定义为

	local function ui.parse(name)
	{
		-- 使用新的环境
		return function()
		{
			-- 解释
			-- 恢复原来的环境
		}
	}
	
ui.parse里面切换了环境，使得之后的Button, Layer等函数，是可见的，之后再切换原始的环境，这样就不用污染全局空间了。

设计好配置格式之后，一切就很好办了。ui界面库提供了3个函数

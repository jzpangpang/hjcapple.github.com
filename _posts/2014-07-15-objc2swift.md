---
title: 从 Objective-C 到 Swift
layout: post
published: true

---
本文发表于《程序员》杂志，2014年7月刊。发表时略有修改。

今年的 WWDC 大会，苹果在无预兆的情况下，发布了 Swift 编程语言。这语言刚发布就引起广泛关注。

个人认为抛开 Objective-C (下文有时简写为 objc )，单独评论 Swift，是不准确的。我们从 objc 谈起。


## Objective-C
objc 是编写 iOS/Mac 程序的主要语言。编写 iOS/Mac 程序，除了 objc，还可以混合使用 C/C++, 另外也可以嵌入一些脚步语言。但在 UI 部分，使用 objc 最为直接自然。

objc 跟 C++ 都是 C 语言的扩展。C++ 十多年前就已经名满天下。而 objc 虽然也诞生了二十多年，在 iPhone 发布之前，一直不瘟不火。

这两种语言都支持面向对象，设计理念却十分不同。C++ 的面向对象部分，更强调类型，需要知道对象的类型，才可以调用对象的函数。objc 更强调消息的发送。另外 C++ 很看重运行速度，运行时候基本不包含类型信息，整个运行环境是静态的。而 objc 牺牲了一点运行速度，换来更加灵活，完全动态的运行时环境。

### objc 的缺点
初学 iOS 开发，第一个门槛就是 objc 的语法，它的语法跟主流的语言十分不同。有些人甚至觉得它的语法丑陋得无法忍受。 另外 objc 的代码看起来比较啰嗦。如同一个人，看起来怪怪的，不太合群，熟悉之后，又显得太过唠叨。

objc 缺少一些语言的保护机制，成员函数不区分公有私有。并且没有命名空间，模块与模块之间，需要加前缀来区分。比如 Foundation 模块，类前面都加上 NS 前缀，表示 NextStep。

objc 兼容 C 语言。C 语言很多设计不合理的地方，也被引入了 objc 中。

另外 objc 没有采用 GC，它的内存管理采用引用计数的方式，后期引入 ARC (自动引用计数)，这种内存管理方式相比 GC，对程序员的要求较高。


objc 也有很多优点。甚至可以说，objc 的某些缺点，从另一角度看，恰恰是它的优点。

### objc 的优点

#### 动态运行环境，适合 UI 编程
在 objc 中

	[obj doSomthingArg0:arg0 arg1:arg1];

这种语法并非单纯的函数调用，而是向 obj 发送消息。objc 的运行环境是动态的，可以在运行时候判断出某对象能否响应某种消息，而不管此对象是什么类型。

UI 程序大框架就是消息处理。系统接受到某种消息，如程序启动了，列表被选中了，手指在屏幕上移动了，交给可以响应这个消息的对象来处理，而不关心这个对象到底是什么。

#### 方便跟 C/C++ 混合使用
objc 中 C 扩展部分，使用符号 @ 开头，比如 @class, @interface，@"Hello, World"。而它的消息发送语法，使用中括号 []，而不是圆括号 ()。

这种独特另类的语法，使得 objc 的代码，就算跟 C++ 代码混在一起，也很容易被识别出来。

将文件扩展名修改成.mm, 就可以在同一文件中，混合使用 objc, C++。两者直接相互调用，不用经过任何间接层。在需要大量使用 C++ 的场合，比如游戏，这种混编特性很有用。


#### 运行速度相对较快
objc 编译后是机器原生指令，运行时环境也小而紧愁。它采用引用计数的内存管理方式，并引入ARC。ARC 比 GC 更容易引起编程错误，但是 ARC 要比 GC 快。而在性能很重要的场合，objc 也很容易的直接调用 C/C++ 代码。 

相对于其它使用虚拟机，采用 GC，间接调用 C/C++ 的移动平台，速度优势很明显。

Swift 和 Objective-C 的联系
-------
苹果一直在改进 objc, 默认编译器由 GCC 换成 LLVM，并先后加入 literal，block，ARC，Module 等特性。个人觉得最大的两点改进为:

1. ARC + 弱引用，本质还是引用计数。但从人手调用 retain, release, 转成编译器自动插入代码，是个质的飞跃。
2. block + GCD。block 引入函数式风格的代码块，而 GCD 大大简化了编写异步代码编写方式。


WWDC 之后，我开始思考一个问题，苹果为什么不继续改进 objc，而发布 Swift 这门新语言呢？这问题只有苹果自己知道，其它人只能猜测。

可能的原因有：

* Swift 表面看起来很简单，语法跟流行的 C#, javascript，C++ 等语言相似，吸引更多的开发者。
* objc 因为需要兼容 C，限制了它的改进。而 Swift 没有历史包袱，可以自由采用最新的语言设计研究成果。
* 设计者个人品味，Chris Lattner 不习惯 objc 的语法，就去设计个新的。

Swift 虽然是新语言，却融合了 objc 的很多特性。读 Swift 的文档，objc 跟 Swift 的联系，比我想象的更密切。

### Swift 跟 objc 共用同一套运行时环境
我们编写程序，程序运行起来。被机器执行的代码并非全部由我们自己来编写的。需要同时运行很多预先写好的支持性的代码，才能让我们自己的代码运行起来。程序并非单独存在的，运行时候处在一定的环境当中。我总联想到很多小蚂蚁在泥土上面爬，我自己写的程序只是其中一只。

Swift 跟 objc 编译出的程序代码，运行在同一套运行环境上面。Swift 的类型，可以桥接到 objc 的类型，反之一样。Swift 编写的代码可以调用 objc 编写的代码，反之一样。

objc 之前积累下来的大量类库，实现不用改写，Swift 就可以直接调用。

### 同一个工程，可以同时使用 Swift, objc
objc 在一端，Swift 在另一端。两端经中间文件进行桥接。桥接文件包含 objc 的头文件，编译时自动转成 Swift 可以识别的形式。Swift 就可以使用 objc 的类，和 c 的函数。

在 Swift 的类中，加上 @objc(类名) 的字样，objc 也可以使用 Swift 编写的类。但 Swift 跟 C++ 的相互调用，需要 objc 来封装一下。

总的说来，共同使用 Swift 跟 objc/C++，还算方便，但已不能将几种语言的代码，混写在同一文件了。大概是因为 swfit 的语法不像 objc 那样独特，混写难以将 Swift 的代码识别出来。

### Swift 骨子里面的概念，大多数跟 objc 一样
objc 的出现过概念，比如，引用记数，ARC, 属性，协议，接口，初始化，扩展类，命名参数，匿名函数等等，在 Swift 继续有效(可能只是换了个术语)。

我将 Swift 看成是 objc 的一块大大的语法糖。

有个大块头的东西，是原来 objc 没有的，就是泛型。Swift中 将那种操作写一次，就可以作用多个类型的语法叫做generics（泛型），而 C++ 中称为 template（模板），叫法不同，本质是同样的东西。


## 编程语言和语法
新语言出来的时候。总会有种声音认为语言只是工具，更重要的是思想，而不是工具。

认为编程语言是工具，本身并没有大错，但并不能轻视工具的作用。并且语言并非普通的工具，而是思维工具。编程语言就如同数学符号。数学符号也是种思维工具，好的数学符号会帮助使用者思考，更奇妙的是似乎符号本身也会思考。用 0123456789 这些阿拉伯数字进行计算时，会感到一切都很自然，似乎数字本身在计算，而不是人在做计算。

而编程语言的语法很重要，但是语法背后的概念更重要。当明白语法背后的概念之后，从一门语言切换到另一门有着相同概念的语言，会很容易。但语法会影响表达，理论上每门语言都可以表达任何概念。不过当某种概念在某门语言中，很难表达出来，就会倾向于不使用它，这种概念在那门语言的社区就难以被人熟知。

编程语言用来表达思路，表达起来是否自然是很重要的。最理想的是不多不少，刚刚好，写起来自然，读起来更需要自然。并非功能越多的语言越好，而应该越能帮助思考，越容易表达思路的语言越好。

Swift 背后的概念，大多跟 objc 差不多。但 Swift 吸收了很多其它语言的语法，同一个概念，写起来比 objc 简洁得多，自然得多。从表达的角度来说，Swift 比 objc 优秀。

## Swift 的语法

苹果出了本很不错的语法教程，来详细描述 Swift 的语法。在这里，我只挑一些有意思的点来讨论一下。

### 简洁
Swift 的语法，给人第一感觉就是简洁干净。如果省略掉也不引起歧义，那符号基本上可以被省略。

Swift 的所有代码都写在同一文件中，而不像 objc 那样，将声明和实现分拆成两个文件。这样的好处，是实现一个函数，不需要修改两个地方。

看一小段代码

	let count = 10
	var str = "Hello, World!"
	
	// 循环1
	for var i = 0; i < count; i++ {
	    println(str)
	}
	
	// 循环2
	for _ in 0 .. count {
	    println(str)
	}
	
Swift 写起来，有点像脚本语言。这里没有出现类型定义，有人觉得它就是脚本语言，解释执行的。实际上 Swift 是真正的编译语言。通过类型推导，变量的类型可以确定下来。既然省略掉类型也不引起歧义，也就可以省略了。

上面的例子中，传统的句末分号，可以省略。

循环中的 ()，可以省略。

循环 1 是 C 中的传统写法。i 作为计数变量。循环 2，是循环1的等价写法，因为根本不用关心计数变量，就直接写成 _ 。


### 不再兼容 C，修正了很多 objc 中容易出错的地方
#### 例子1
在 C/objc 中，if, while, for 之后的判断式，并不需要一定传入 bool 的类型。也可以传入整形，指针等类型，只要非 0 就为真。并且赋值是有副作用的。

	a = 0;
	
返回 a 的数值。这样就有可能出现，将判断

	if (a == 0) ....
	
错写成

	if (a = 0)  ....

为避免这个问题，有种变通写法写成

	if (0 == a) ...

这写法，被称为 Yoda 表达式，因为《星球大战》中的 Yoda 大师，喜欢使用这样奇特的倒装句子。

而 Swift 在 if, while, for 等判断式子，一定需要传入 bool 类型。并且赋值没有副作用。这样写成

	if a = 0 ...
	
这种判断，就会编译错误。Yoda 表达式这种变通写法，再也没有必要。

#### 例子2
还是拿判断来说。在 C/objc 中，if，while，for 之后的语句，假如只有一行，是可以省略掉 {} 的。比如

	if ((err = SSLHashSHA1.update(&hashCtx, &signedParams)) != 0) 
        goto fail; 
        
当后面的人，修改代码。或者多人修改同一代码，再合并的时候。可能会在 if 后面直接插入一行。

	if ((err = SSLHashSHA1.update(&hashCtx, &signedParams)) != 0) 
        goto fail; 
        goto fail; 
这样，就一定会 goto fail了。

Swift 中，强制要求 if, while, for 之后，一定需要写{}, 不管是不是只有一行。

一些经典错误

* switch 中的 case 忘记写 break
* int \*a, \*b, \*c; 写成 int* a, b, c;
* 基类的虚函数修改了名字，子类忘记修改了。

在Swift中，也被修正了，从语言层面保证不可能发生。


### 常用类型，集成到语言里面，而非以库的形式提供
有几种类型，几乎每个项目中都使用到

* 整数，浮点数，布尔型，空值
* 字符串
* 数组，字典

对这些类型的支持，每个语言都有所不同。有些老旧的语言，不支持浮点。有些语言中，布尔，空值是整数的一种。有些语言中，整数和浮点数合并成一类，统称 Number。有些语言中，并没有字符串，字典，数组。有些语言，字典，数组归成一类。

语言不提供的类型，多数以库的形式提供。比如在 C++ 中，语言内部并没有提供字符串，字典，数组，但这些类型出现在标准库的中。使用库的形式来提供常用类型，优点是减少语言自身的复杂度，另外库可以自由替换。而采用语言直接支持的方式，使用起来会很简洁流畅。 

Swift 中 的常用类型，集成到语言内部。
数组写成
	
	[a, b, c, d]
	
字典写成

	[key1:value1, key2:value2, key3:value3]
	
这种写法，在原来的 objc 中就已经出现了，融入到 Swift 中。

另外 Swift 支持另外两种类型。

* option
* tuple

option 用来表示有值，或根本无值。而 tuple 表示多个值。使用 tuple，这样就可以从函数中返回多个值，或者一行代码交换两个值。

在 C++ 中，这两种类型，也采用库的方式来提供。std::tie 跟 std::tuple 结合，可以达到返回多重值的效果，但是显得语法噪音多，不够方便，也比较少用。


### 支持多种编程泛式
将 Swift 分拆开，大致分成以下部分。

* 基本类型
* 控制流
* 函数定义和调用
* 函数式编程
* 面向对象
* 泛型

Swift 的内容很多，可以说很复杂，并非表面看来那样简单。Swift 从语法上，直接支持现代流行的编程泛式：结构化编程，函数式编程，面向对象，泛型。每一部分，Swift 都有些闪光点，不能一一述说。

我特别喜欢它函数式编程部分。直接拿文档的一个排序例子，看看它是怎么简化编程的。

#### 最开始版本，传递函数
	let names = ["Chris", "Alex", "Ewa", "Barry", "Daniella"]
	
	func backwards(s1: String, s2: String) -> Bool {
    	return s1 > s2
	}
	var reversed = sort(names, backwards)
	
#### 使用闭包

	reversed = sort(names, { (s1: String, s2: String) -> Bool in
    	return s1 > s2
	})
	
#### 可以推导出参数类型，参数类型省略

	reversed = sort(names, { s1, s2 in return s1 > s2 } )
	
#### 可以推导出返回类型，return 省略

	reversed = sort(names, { s1, s2 in s1 > s2 } )
	
#### 省略掉闭包里面变量

	reversed = sort(names, { $0 > $1 })
	
#### 假如闭包是函数的最后一个类型，可以将{}, 提到外面

	reversed = sort(names) {
    	$0 > $1
	}

#### 使用操作符函数，最后版本
	reversed = sort(names, >)


### 可以很好地支持内部 DSL

有一种编程风格，不太好归类。就是将程序拆分成，描述+解释。解释部分写一次，其它地方使用描述式的语句，而不是命令式的语句。

内部DSL，通常利用主语言的语法特性，创出一套写法，来写一些描述性的语句。这些语句组合起来，就像一门新语言似得。举个从ruby 那里借过来的例子。假如计算，几小时之后的秒数。

C 语言中，大致写成

	getHourSeconds(3);
	
而现在 Swift中，定义了扩展

	extension Int {
	    var hours:Int {
	        return self * 3600
	    }
		
	    var ago:Int {
	        return -self
	    }
	}
	
就可以写成

	3.hours
	3.hours.ago
	
分别是 3 小时后的秒数，3 小时前的秒数。
同理，也可以写成

	10.days
	10.days.ago
	
这种写法，看起来跟原来的命令式写法完全不同。这些语句是描述性的。原来的 objc, 做不到这点。估计 Swift 以后会冒出大量这样风格的库。

这种风格，到底好不好，要看情况。比较方便定义内部DSL的语言, 我自己知道的有 C++, Ruby, Lisp。现在多了Swift。

### 其它
Swift 的语法，还有很多有意思的地方。比如属性的中 get，set。switch case 中的模式匹配，泛型中的类型约束等等。这里不能一一细说了。


## Swift 的一些争议性地方
下面列出一些，Swift 争议性较大的地方

* 东抄西抄一些语法，大杂烩，没有自己的原创
* 没有一些 private, protected 之类的权限控制
* 没有采用垃圾收集，采用 ARC
* 没有异常处理
* 是否可以跳过 objc, 直接学习 Swift

对此很难作出客观评价，也没有结论。我感觉 Swift 这门语言还是比较有意思的。有些人写程序，只是单纯为了好玩的。

据我观察，使用 objc 的，多数会比较喜欢 ARC, 而不是垃圾收集。

而异常并非一定好的。异常的问题在于发生异常的地方，跟处理异常的地方分离开来，真正处理的时候，难以收集到足够的信息。异常容易滥用，只抛出，不处理，或者只在最外层接收所有异常，跟着打印信息。这样的话，也就失去异常处理的意义。

原来 ojc 中的异常功能，几乎没有人使用。对于Swift, 采用多返回值，加上 option 的方式来处理错误，可能会更好。

## 可视化编程
WWDC 发布会上，演示了 Swift 的 playground 功能。敲入代码，立即有反馈。当我们每一步操作，都得到实时地反馈，我们的做法会有很多不同，做出的东西也会不同。

可视化编程放到最后，并非是它不重要，而是实在太重要了，我根本没有资格和能力评说。关于这部分，强烈建议看 Bret Victor 的演讲视频和文章。

## 最后

Swift 还有很多主题，这篇文章并没有提及到。只能靠大家研究了。Write the Code. Change the World。




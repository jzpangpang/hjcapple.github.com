<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="author" content="HJC" />
    
    <title>延迟执行的一个例子</title>
    
    <link href="/atom.xml" rel="alternate" title="HJC Blog" type="application/atom+xml" />
    <link rel="stylesheet" href="/media/css/main.css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link href="http://cdn.bootcss.com/highlight.js/8.0/styles/default.min.css" rel="stylesheet">

    <script type="text/javascript"
      src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>
  </head>
  <body>
      <div id="main" role="main">
        <header>
          <div id="header">
            <h1><a title="HJC Blog" class="" href="/">HJC Blog</a></h1>
          </div>
          <nav>
            
            <span><a title="文章" href="/index.html">文章</a></span>
            
            <span><a title="我" href="/about.html">我</a></span>
            
          </nav>
        </header>
        <div id="content">
        <article>
  <section class="title">
    <h2>延迟执行的一个例子 </h2>
  </section>

  <section class="meta">

  <span class="tags">
    <p>版权所有，未经许可请勿转载</p>
  </span>

  <span class="time">
    <time datetime="2009-07-16">2009-07-16</time>
  </span>
  
  <span class="tags">
    
    <a href="/tags.html#C++" title="C++">#C++</a>
    
  </span>
  
  </section>
  <section class="post">
  <h2 id="section">问题</h2>
<p>相信大家多多少少都有拖延的毛病。比如要你收拾屋子，就可能会拖上两个星期，等自己习惯了，就不觉得乱了。当然上面说的那种拖拉是不好，但适当的懒惰是人们前进的动力。程序设计中有些技术就用到了拖延战术。如写时复制等。</p>

<p>假如有个类，构造函数的开销很大，需要全局访问，又不一定需要用到。你会怎样做？将这个类暂时定名为BigClass。一个例子就是打印错误信息的类，可能没有出错，就没有必要使用。</p>

<h2 id="section-1">方案1</h2>
<p>你直接定义 </p>

<pre><code>	BigClass myClass;
</code></pre>

<p>这样BigClass的构造函数一开始就被调用了，如果没有用到这类，构造函数是浪费了。</p>

<h2 id="section-2">方案2</h2>
<p>定义一个指针。</p>

<pre><code>	BigClass* pClass = NULL; 
</code></pre>

<p>真正需要用到再判断指针，再new或用工厂方式构造出来。
这方案是不错的，大部份情况也可以了。但new需要内存，如果内存不足，new返回错误怎么办。比如那个打印错误信息的类，如果内存不足，需要这个类来打印错误。但new这个类出来的时候又出现内存不足，这个类构造不出来。</p>

<h2 id="section-3">方案3</h2>
<p>定一个函数。比如</p>

<pre><code>	BigClass* getBigClass()
	{
	 	static BigClass myclass;
	 	return &amp;myclass;
	}
</code></pre>

<p>这个方案，可以摆脱那个new分配内存的问题。因为myclass已经在_BSS段有空间了。妙的是第一次调用getBigClass()函数的时候，BigClass的构造函数才会执行，这样就可以省下没有必要的构造函数调用。每次拿指针都要调用一个函数，可能有些人觉得不方便。</p>

<h2 id="section-4">方案4</h2>
<p>定义一个指针，跟一个数组。</p>

<pre><code>	char classBuff[sizeof(BigClass)];
	BigClass* pClass = NULL;
</code></pre>

<p>需要的时候，调用 </p>

<pre><code>	pClass = new(classBuff) BigClass. 
</code></pre>

<p>这是placement new的一种用法。这方案预先分配好内存，并避免过早调用构造函数。这写法对于不了解placement new的人来说比较怪异。</p>

<h2 id="section-5">总结</h2>
<p>其实不一定说那种方案好，根据不同的时候可以采用不同的做法。很多所谓的方案，原则都是死的，人是活的。比如原则，如果你不了解为什么要定这原则，那你最好遵守。但如果你很明白那原则为什么要这样，看透了它的优点跟不足，那你根据情况可以适当违反。</p>

  </section>
  
  <div class="divider">
    <span>
    
    <a href="/2009/07/15/thread-local-storage.html"><i class="fa fa-chevron-left"></i></a>
    
    </span>
    <!-- BEGIN comment icon
    <span><a href="javascript:leave_comment();" id="leave_comment_link"><i class="fa fa-comment-o"></i></a></span>
    <span><a href="javascript:collapse_comment();" id="collapse_comment_link" style="display:none;"><i class="fa fa-chevron-up"></i></a></span>
      END comment icon -->

    <span>
    
    <a href="/2009/07/26/ai-pattern.html"><i class="fa fa-chevron-right"></i></a>
    
    </span>
  </div>

  
</article>

        </div>
        <footer>
          <div>
            
            &copy; 2006 ~ 2014 HJC | powered by jekyll | themed by <a href="http://lhzhang.com" title="sext vi">sext vi</a> | <a href="https://github.com/hjcapple/hjcapple.github.com" title="fork me">fork me</a>
          </div>
        </footer>
      </div> <!-- main -->

      <script src="http://cdn.bootcss.com/highlight.js/8.0/highlight.min.js"></script>
      <script >hljs.initHighlightingOnLoad();</script>
  </body>
</html>
